$dc1 = "NJPVDCTEST01"
$zones = (Get-DnsServerZone).ZoneName
$backupFile = "C:\Scripts\all-dns-records-backup.csv"

Write-Host "Checking connectivity to $dc1..."
if (Test-Connection -ComputerName $dc1 -Count 1 -Quiet) {
    Write-Host "‚úÖ DC1 is reachable. No failover needed."
    exit
}

Write-Host "‚ùå DC1 is unreachable. Running Failover Mode..."

# Step 1: Backup all records (A, CNAME, etc.) from all zones
Write-Host "Backing up all DNS records..."
$allRecords = foreach ($zone in $zones) {
    Get-DnsServerResourceRecord -ZoneName $zone |
    Select-Object @{Name='ZoneName';Expression={$zone}},
                  @{Name='RecordType';Expression={$_.RecordType}},
                  @{Name='HostName';Expression={$_.HostName}},
                  @{Name='RecordData';Expression={$_.RecordData}}
}
$allRecords | Export-Csv -Path $backupFile -NoTypeInformation
Write-Host "üóÇÔ∏è All DNS records backup saved to: $backupFile"

# Step 2: For each A record (excluding -dr) ‚Üí create CNAME pointing to -dr and delete A
Write-Host "Processing failover logic..."

foreach ($rec in $allRecords | Where-Object { $_.RecordType -eq 'A' -and $_.HostName -notmatch '-dr$' }) {
    $zone = $rec.ZoneName
    $name = $rec.HostName
    $drName = "$name-dr"

    # Check if DR record exists
    $drRecord = Get-DnsServerResourceRecord -ZoneName $zone -Name $drName -ErrorAction SilentlyContinue
    if ($drRecord) {
        try {
            Add-DnsServerResourceRecordCName -ZoneName $zone -Name $name -HostNameAlias "$drName.$zone" -ErrorAction Stop
            Remove-DnsServerResourceRecord -ZoneName $zone -Name $name -RRType "A" -Force
            Write-Host "‚úÖ Created CNAME for $name ‚Üí $drName in zone $zone"
        }
        catch {
            Write-Warning "‚ö†Ô∏è Failed to create CNAME for $name in $zone: $($_.Exception.Message)"
        }
    } else {
        Write-Warning "‚ö†Ô∏è No DR record found for $name in $zone ‚Äî skipping."
    }
}

Write-Host "üèÅ Failover completed successfully!"
