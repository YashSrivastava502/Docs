

def process_alert(alert, recep_dict, owner_email, cc_email, recep_dict2):
    base_url = "https://portal.azure.com/#@fareportal.com"
    
    # Launch Chrome with remote debugging port (if not already running)
    try:
        subprocess.Popen([
            "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe",
            "--remote-debugging-port=9222",
            "--user-data-dir=C:\\Temp\\ChromeProfile"  # Use a temporary profile to avoid conflicts
        ])
        time.sleep(3)  # Wait for Chrome to start
    except Exception as e:
        print(f"Failed to launch Chrome: {e}. Ensure Chrome is installed or running with --remote-debugging-port=9222.")

    # Configure Selenium to connect to existing Chrome instance
    chrome_options = Options()
    chrome_options.add_experimental_option("debuggerAddress", "localhost:9222")
    
    # Initialize Selenium WebDriver to control default Chrome
    driver = webdriver.Chrome(options=chrome_options)
    driver.maximize_window()

    target_resource = alert.get("targetResource")
    target_resource_name = alert.get("targetResourceName")
    severity = alert.get("severity")
    alert_description = alert.get("name")
    alert_description_lower = alert_description.lower()
    print(alert_description_lower)
    full_url = f"{base_url}/resource{target_resource}"

    retries = 2  # Retry page load up to 2 times
    for attempt in range(retries):
        try:
            driver.get(full_url)
            WebDriverWait(driver, 30).until(EC.presence_of_element_located((By.XPATH, "//body")))  # Increased timeout to 30s
            
            # Sign-in is not required, so skipping
            # email = appinsight_report_config.SENDER_EMAIL
            # password = appinsight_report_config.SENDER_PASSWORD
            # sign_in(driver, email, password)

            if "failed" in alert_description_lower or "failure" in alert_description_lower or "failures" in alert_description_lower:
                failures_menu_locator = "div[data-telemetryname='Menu-failures']"
                WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.CSS_SELECTOR, failures_menu_locator))).click()
                if "dependency" in alert_description_lower or "dapendency" in alert_description_lower or "dependency failure" in alert_description_lower:
                    time.sleep(20)
                    iframe = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CLASS_NAME, "fxs-part-frame")))
                    print("Found iframe:", iframe)
                    driver.switch_to.frame(iframe)
                    button = driver.find_element(By.ID, "Dependencies")
                    button.click()
                    time.sleep(15)
                    screenshot_filename = f"screenshots/{target_resource_name}.png"
                    driver.save_screenshot(screenshot_filename)
                    send_email(target_resource_name, owner_email, screenshot_filename, severity, alert_description, cc_email)
                    print(f"Alert email sent for {target_resource_name}")
                    driver.quit()
                elif "exception" in alert_description_lower:
                    time.sleep(20)
                    iframe = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CLASS_NAME, "fxs-part-frame")))
                    print("Found iframe:", iframe)
                    driver.switch_to.frame(iframe)
                    button = driver.find_element(By.ID, "Exceptions")
                    button.click()
                    time.sleep(15)
                    screenshot_filename = f"screenshots/{target_resource_name}.png"
                    driver.save_screenshot(screenshot_filename)
                    send_email(target_resource_name, owner_email, screenshot_filename, severity, alert_description, cc_email)
                    print(f"Alert email sent for {target_resource_name}")
                    driver.quit()
            else:
                time.sleep(20)
                WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.CSS_SELECTOR, "div[data-telemetryname='Menu-performance']"))).click()
                time.sleep(10)
                screenshot_filename = f"screenshots/{target_resource_name}.png"
                driver.save_screenshot(screenshot_filename)
                send_email(target_resource_name, owner_email, screenshot_filename, severity, alert_description, cc_email)
                print(f"Alert email sent for {target_resource_name}")
                driver.quit()
            break  # Exit retry loop on success
        except TimeoutException:
            print(f"Timeout occurred while loading {full_url} (attempt {attempt + 1}/{retries})")
            if attempt == retries - 1:
                print("Max retries reached. Skipping alert.")
        finally:
            driver.quit()
