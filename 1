$dc1 = "NJPVDCTEST01"
$zones = (Get-DnsServerZone).ZoneName
$backupFile = "C:\Scripts\original-records.csv"

Write-Host "Checking connectivity to $dc1..."
if (Test-Connection -ComputerName $dc1 -Count 1 -Quiet) {
    Write-Host "DC1 is reachable. No failover needed."
    exit
}

Write-Host "DC1 is unreachable. Running Failover Mode."

# Step 1: Backup all existing A records
$records = foreach ($zone in $zones) {
    Get-DnsServerResourceRecord -ZoneName $zone -RRType "A" |
    Where-Object { $_.HostName -notmatch '-dr$' } | # exclude DR records
    Select-Object HostName, RecordData, ZoneName
}
$records | Export-Csv -Path $backupFile -NoTypeInformation
Write-Host "A record backup saved to $backupFile"

# Step 2: Create CNAMEs pointing to DR records and delete original A records
foreach ($rec in $records) {
    $zone = $rec.ZoneName
    $name = $rec.HostName
    $drName = "$name-dr"

    # Check if DR record exists
    $drRecord = Get-DnsServerResourceRecord -ZoneName $zone -Name $drName -ErrorAction SilentlyContinue
    if ($drRecord) {
        try {
            Add-DnsServerResourceRecordCName -ZoneName $zone -Name $name -HostNameAlias "$drName.$zone" -ErrorAction Stop
            Remove-DnsServerResourceRecord -ZoneName $zone -Name $name -RRType "A" -Force
            Write-Host "✅ Created CNAME for $name → $drName"
        }
        catch {
            Write-Warning "⚠️ Failed to create CNAME for $name in $zone: $($_.Exception.Message)"
        }
    } else {
        Write-Warning "⚠️ No DR record found for $name in $zone, skipping."
    }
}

Write-Host "Failover completed successfully!"
