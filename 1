from playwright.sync_api import sync_playwright
import time

def process_alert(alert, recep_dict, owner_email, cc_email, recep_dict2):
    base_url = "https://portal.azure.com/#@fareportal.com"
    target_resource = alert.get("targetResource")
    target_resource_name = alert.get("targetResourceName")
    severity = alert.get("severity")
    alert_description = alert.get("name")
    alert_description_lower = alert_description.lower()
    print(alert_description_lower)
    full_url = f"{base_url}/resource{target_resource}"

    screenshot_filename = f"screenshots/{target_resource_name}.png"

    with sync_playwright() as p:
        browser = p.chromium.launch_persistent_context(
            user_data_dir=r"C:\Users\y.s.va22\AppData\Local\Google\Chrome\User Data",
            headless=False,
        )
        page = browser.new_page()
        try:
            page.goto(full_url, timeout=60000)
            page.wait_for_load_state("networkidle")
            time.sleep(20)  # Let the page fully render

            if "failed" in alert_description_lower or "failure" in alert_description_lower:
                page.click("div[data-telemetryname='Menu-failures']", timeout=10000)

                # Wait for iframe and switch
                iframe_element = page.wait_for_selector("iframe.fxs-part-frame", timeout=20000)
                frame = iframe_element.content_frame()

                if "dependency" in alert_description_lower:
                    frame.click("#Dependencies", timeout=10000)
                elif "exception" in alert_description_lower:
                    frame.click("#Exceptions", timeout=10000)

                time.sleep(15)
            else:
                page.click("div[data-telemetryname='Menu-performance']", timeout=10000)
                time.sleep(10)

            page.screenshot(path=screenshot_filename, full_page=True)
            send_email(target_resource_name, owner_email, screenshot_filename, severity, alert_description, cc_email)
            print(f"Alert email sent for {target_resource_name}")

        except Exception as e:
            print(f"Playwright error: {e}")
        finally:
            browser.close()
