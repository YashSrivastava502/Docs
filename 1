import base64
from elasticsearch import Elasticsearch
from ME_weekly_cleanup_config import e_password, e_username, elasticsearch_url

# Basic authentication (used by Elasticsearch client)
auth_header = base64.b64encode(f"{e_username}:{e_password}".encode()).decode()

# Index pattern with wildcard
common_index = 'common-events-notification*'

# Initialize Elasticsearch client
es = Elasticsearch(
    [elasticsearch_url],
    basic_auth=(e_username, e_password),
)

def delete_alerts():
    try:
        # Read list of document IDs from file
        with open("Alert_ids.txt", "r") as file:
            ids = file.read().splitlines()

        for doc_id in ids:
            delete_query = {
                "query": {
                    "term": {
                        "_id": doc_id  # Match exact _id
                    }
                }
            }

            response = es.delete_by_query(index=common_index, body=delete_query, conflicts="proceed", refresh=True)

            deleted_count = response.get('deleted', 0)
            if deleted_count > 0:
                print(f"✅ Deleted document with ID: {doc_id}")
            else:
                print(f"⚠️ Document ID not found or already deleted: {doc_id}")

    except Exception as e:
        print(f"❌ Error during deletion: {e}")

# Run the deletion function
delete_alerts()

