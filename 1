#!/bin/bash

# ------------------ üîß CONFIGURATION ---------------------
RG="usei-dr-rgp01"
LOCATION="East US"

# VM1 - Source
VM1_NAME="use1-dr-websrv01-vm"
VNET1="usel-drd-fp-inf-net01"
SUBNET1="usel-dr01-fp-srv-snet01"

# VM2 - Destination
VM2_NAME="use1-dr-websrv02-vm"
VNET2="use1-drd-fp-hub-net01"
SUBNET2="usel-drd-fp-hub-srv-snet01"

# VM config
VM_SIZE="Standard_B1s"
USERNAME="azureuser"
PASSWORD="YourStrongPassword123!"

# Snapshot / Storage
SNAPSHOT_NAME="use1-dr-websrv01-snapshot"
DISK_NAME="use1-dr-websrv01-clone-disk"
STORAGE_ACCOUNT="fpinfbackup"
CONTAINER="syseng"
BLOB_PATH="use1-dr-websrv01-vm/use1-dr-websrv01-osdisk.vhd"

# ------------------ üõ†Ô∏è STEP 1: CREATE VM1 ---------------------
az vm create \
  --resource-group "$RG" \
  --name "$VM1_NAME" \
  --image Ubuntu2204 \
  --size "$VM_SIZE" \
  --admin-username "$USERNAME" \
  --admin-password "$PASSWORD" \
  --vnet-name "$VNET1" \
  --subnet "$SUBNET1" \
  --public-ip-sku Standard \
  --location "$LOCATION"

# ------------------ üõ†Ô∏è STEP 2: INSTALL NGINX (Blue Page) ---------------------
az vm extension set \
  --resource-group "$RG" \
  --vm-name "$VM1_NAME" \
  --name CustomScript \
  --publisher Microsoft.Azure.Extensions \
  --settings '{"commandToExecute":"sudo apt update && sudo apt install -y nginx && echo \"<html><body style='\''background-color:blue;'\''><h1>Blue Page</h1></body></html>\" | sudo tee /var/www/html/index.html && sudo systemctl restart nginx"}'

# ------------------ üõ†Ô∏è STEP 3: DEALLOCATE VM1 & SNAPSHOT ---------------------
az vm deallocate --resource-group "$RG" --name "$VM1_NAME"

OSDISK_NAME=$(az vm show --resource-group "$RG" --name "$VM1_NAME" --query "storageProfile.osDisk.name" -o tsv)

az snapshot create \
  --resource-group "$RG" \
  --source "$OSDISK_NAME" \
  --name "$SNAPSHOT_NAME" \
  --location "$LOCATION"

# ------------------ üõ†Ô∏è STEP 4: EXPORT SNAPSHOT TO BLOB ---------------------
SAS_URL=$(az snapshot grant-access \
  --resource-group "$RG" \
  --name "$SNAPSHOT_NAME" \
  --duration-in-seconds 3600 \
  --query accessSas -o tsv)

az storage blob copy start \
  --account-name "$STORAGE_ACCOUNT" \
  --destination-container "$CONTAINER" \
  --destination-blob "$BLOB_PATH" \
  --source-uri "$SAS_URL"

echo "‚è≥ Waiting 2 minutes for blob copy to finish..."
sleep 120

# ------------------ üõ†Ô∏è STEP 5: CREATE MANAGED DISK FROM BLOB ---------------------
BLOB_URL="https://${STORAGE_ACCOUNT}.blob.core.windows.net/${CONTAINER}/${BLOB_PATH}"

az disk create \
  --resource-group "$RG" \
  --name "$DISK_NAME" \
  --source "$BLOB_URL" \
  --os-type Linux \
  --location "$LOCATION"

# ------------------ üõ†Ô∏è STEP 6: CREATE VM2 FROM CLONED DISK ---------------------
az vm create \
  --resource-group "$RG" \
  --name "$VM2_NAME" \
  --attach-os-disk "$DISK_NAME" \
  --os-type Linux \
  --size "$VM_SIZE" \
  --vnet-name "$VNET2" \
  --subnet "$SUBNET2" \
  --admin-username "$USERNAME" \
  --admin-password "$PASSWORD" \
  --public-ip-sku Standard \
  --location "$LOCATION"

# ------------------ ‚úÖ STEP 7: VERIFY ---------------------
VM2_PUBLIC_IP=$(az vm show --resource-group "$RG" --name "$VM2_NAME" --show-details --query "publicIps" -o tsv)

echo ""
echo "‚úÖ VM2 created from VM1 snapshot!"
echo "üåê Open in browser: http://$VM2_PUBLIC_IP"
