trigger:
- main   # or disable auto trigger if you want manual only

pool:
  name: 'DR-Ansible'   # Your self-hosted agent

parameters:
- name: action
  displayName: "Select VM Action"
  type: string
  default: 'stop'
  values:
  - start
  - stop

steps:
- script: |
    echo "Running Azure VM Control Script with action: ${{ parameters.action }}"
    chmod +x ./vm-control.sh
    ./vm-control.sh ${{ parameters.action }}
  displayName: 'Run VM Control Script'
# Get all VM names in resource group
VMS=$(az vm list -g $RESOURCE_GROUP --query "[].name" -o tsv)

for VM in $VMS; do
    # Skip excluded VM
    if [[ "$VM" == "$EXCLUDE_VM" ]]; then
        echo "Skipping excluded VM: $VM" | tee -a $LOG_FILE
        continue
    fi

    if [ "$ACTION" == "start" ]; then
        echo "Starting VM: $VM" | tee -a $LOG_FILE
        az vm start -g $RESOURCE_GROUP -n $VM >> $LOG_FILE 2>&1
    elif [ "$ACTION" == "stop" ]; then
        echo "Stopping VM: $VM" | tee -a $LOG_FILE
        az vm deallocate -g $RESOURCE_GROUP -n $VM >> $LOG_FILE 2>&1
    else
        echo "âŒ Invalid action. Use 'start' or 'stop'." | tee -a $LOG_FILE
        exit 1
    fi
done

echo "$(date '+%Y-%m-%d %H:%M:%S') - Completed $ACTION operation" >> $LOG_FILE
echo "----------------------------------------" >> $LOG_FILE
