# Step 3: Restore original A records from backup CSV when DC1 is reachable
Write-Host "DC1 is reachable. Running Fallback Mode..."

if (Test-Path $backupFile) {
    $records = Import-Csv $backupFile

    foreach ($record in $records) {
        $zoneName = $record.Zone
        $name = $record.Name
        $type = $record.Type
        $data = $record.Data

        try {
            # Only restore A records with valid IP addresses
            if ($type -eq "A" -and $data -match "^\d{1,3}(\.\d{1,3}){3}$") {
                # Delete any existing CNAME (failover record)
                $existingCname = Get-DnsServerResourceRecord -ZoneName $zoneName -Name $name -RRType CNAME -ErrorAction SilentlyContinue
                if ($existingCname) {
                    Remove-DnsServerResourceRecord -ZoneName $zoneName -RRType CNAME -Name $name -Force -ErrorAction SilentlyContinue
                    Write-Host "Deleted CNAME for $name in $zoneName"
                }

                # Add original A record back
                Add-DnsServerResourceRecordA -ZoneName $zoneName -Name $name -IPv4Address $data -TimeToLive 01:00:00 -ErrorAction Stop
                Write-Host "Restored A record: $name -> $data in $zoneName"
            }
            else {
                Write-Warning "Skipping invalid or missing IP for $name in $zoneName"
            }
        }
        catch {
            Write-Warning "Error restoring $name in $zoneName: $($_.Exception.Message)"
        }
    }
}
else {
    Write-Warning "No backup file found to restore records."
}
