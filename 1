#!/usr/bin/env python3

import json
import subprocess
import csv
import smtplib
from email.message import EmailMessage
from datetime import datetime

# =========================
# CONFIGURATION
# =========================
RESOURCE_GROUP = "YOUR_RESOURCE_GROUP"

SMTP_SERVER = "smtp.yourcompany.local"
SMTP_PORT = 25
MAIL_FROM = "infra-report@yourcompany.com"
MAIL_TO = ["ops@yourcompany.com"]

CSV_FILE = f"azure_vm_inventory_{RESOURCE_GROUP}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"

# =========================
# AZ CLI HELPER
# =========================
def az(cmd):
    result = subprocess.check_output(cmd, shell=True)
    return json.loads(result)

# =========================
# VM SIZE CACHE (PER REGION)
# =========================
print("Fetching VM size reference...")
size_cache = {}

def get_size_map(location):
    if location not in size_cache:
        sizes = az(f"az vm list-sizes --location {location}")
        size_cache[location] = {
            s["name"]: {
                "cpu": s.get("numberOfCores", "NA"),
                "ram": round(
                    (s.get("memoryInMb") or s.get("memoryMB") or 0) / 1024, 1
                )
            }
            for s in sizes
        }
    return size_cache[location]

# =========================
# FETCH VMS
# =========================
print("Fetching VMs...")
vms = az(f"az vm list -g {RESOURCE_GROUP} -d")

rows = []

for vm in vms:
    name = vm["name"]
    status = vm.get("powerState", "unknown")
    private_ip = vm.get("privateIps", "")
    os_type = vm["storageProfile"]["osDisk"]["osType"]
    size = vm["hardwareProfile"]["vmSize"]
    location = vm["location"]

    size_map = get_size_map(location)
    cpu = size_map.get(size, {}).get("cpu", "NA")
    ram = size_map.get(size, {}).get("ram", "NA")

    # DISKS
    disks = []
    os_disk = vm["storageProfile"]["osDisk"]
    disks.append(f"OS:{os_disk['diskSizeGb']}GB")

    for d in vm["storageProfile"].get("dataDisks", []):
        disks.append(f"DATA:{d['diskSizeGb']}GB")

    disk_str = "; ".join(disks)

    # TAGS
    tags = vm.get("tags") or {}
    tag_str = "; ".join([f"{k}={v}" for k, v in tags.items()]) if tags else "NO_TAGS"

    rows.append([
        name,
        status,
        private_ip,
        os_type,
        size,
        cpu,
        ram,
        disk_str,
        tag_str
    ])

# =========================
# WRITE CSV
# =========================
print("Writing CSV...")
headers = [
    "NAME",
    "STATUS",
    "PRIVATE_IP",
    "OS",
    "SIZE",
    "CPU_vCPUs",
    "RAM_GB",
    "DISKS",
    "TAGS"
]

with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
    writer = csv.writer(f)
    writer.writerow(headers)
    writer.writerows(rows)

# =========================
# EMAIL CSV
# =========================
print("Sending email...")

msg = EmailMessage()
msg["From"] = MAIL_FROM
msg["To"] = ", ".join(MAIL_TO)
msg["Subject"] = f"Azure VM Inventory - {RESOURCE_GROUP}"

msg.set_content(f"""
Hello Team,

Please find attached the Azure VM inventory report.

Resource Group : {RESOURCE_GROUP}
Total VMs       : {len(rows)}
Generated On    : {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

This report includes:
- VM Name
- Power State
- Private IP
- OS Type
- VM Size
- CPU & RAM
- OS and Data Disk sizes
- Tags

Regards,
Cloud & Automation Team
""")

with open(CSV_FILE, "rb") as f:
    msg.add_attachment(
        f.read(),
        maintype="text",
        subtype="csv",
        filename=CSV_FILE
    )

with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as s:
    s.send_message(msg)

print("âœ… Done. CSV generated and emailed successfully.")
