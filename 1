#!/usr/bin/env python3
"""
main.py - Capacity Management Dashboard (Advanced Tabs + Auto Refresh)

Features:
- Professional Sidebar Navigation (Dashboard, Events, Inventory).
- Auto-Refresh every 60 seconds.
- Inventory Table with "Spaced" columns.
- Preserves all logic (Reconciler, Logic, CSV, DB).
"""

import os
import io
import base64
import threading
import time
from datetime import datetime, timedelta, timezone

import pandas as pd
import plotly.graph_objects as go
from sqlalchemy import create_engine, text

import logging
from logging.handlers import TimedRotatingFileHandler

from dash import Dash, dcc, html, Input, Output, State, callback_context, no_update
import dash_bootstrap_components as dbc

# Load your configuration
try:
    from config import DB_CONFIG, TOTAL_CAPACITY, RESERVED_PERCENT
except ImportError:
    print("WARNING: config.py not found. Using defaults.")
    DB_CONFIG = {"user": "postgres", "password": "password", "host": "localhost", "port": "5432", "dbname": "capacity_db"}
    TOTAL_CAPACITY = {"CPU": 1000, "RAM": 5000, "STORAGE": 500} # Storage in TB
    RESERVED_PERCENT = 0.15

# ---------------- Logging ----------------
logger = logging.getLogger("capacity_dashboard")
logger.setLevel(logging.INFO)
handler = TimedRotatingFileHandler("capacity.log", when="midnight", backupCount=7)
handler.setFormatter(logging.Formatter("%(asctime)s - %(levelname)s - %(message)s"))
if not logger.handlers:
    logger.addHandler(handler)

# ---------------- DB Engine ----------------
ENGINE = create_engine(
    f"postgresql+psycopg2://{DB_CONFIG['user']}:{DB_CONFIG['password']}@"
    f"{DB_CONFIG['host']}:{DB_CONFIG['port']}/{DB_CONFIG['dbname']}",
    pool_pre_ping=True
)

# ---------------- Constants ----------------
INVENTORY_STATUS = ("Running", "Running/Not in Production")
INVENTORY_LOCATION = "NJ Datacenter"
INVENTORY_TYPE = "Server/VM"
RECONCILE_INTERVAL = int(os.environ.get("RECONCILE_INTERVAL", "300"))
RUN_RECONCILER = os.environ.get("RUN_RECONCILER", "true").lower() in ("true", "1", "yes")

# ---------------- Styling Constants ----------------
COLORS = {
    "background": "#f4f6f9",
    "text": "#2c3e50",
    "cpu": "#4e73df",     # Blue
    "ram": "#1cc88a",     # Green/Teal
    "storage": "#6f42c1"  # Purple
}

# ---------------- Helpers ----------------
def now_utc():
    return datetime.now(timezone.utc)

def fmt_cpu(v):
    return f"{int(round(float(v or 0))):,} Cores"

def fmt_ram_gb(v):
    return f"{float(v or 0):,.1f} GB"

def fmt_storage_tb(v):
    return f"{(float(v or 0)/1024.0):,.2f} TB"

def parse_csv(contents, filename):
    if not contents:
        raise ValueError("No file uploaded")
    header, content_string = contents.split(",", 1)
    decoded = base64.b64decode(content_string)
    df = pd.read_csv(io.StringIO(decoded.decode("utf-8")))
    lc = [c.lower() for c in df.columns]
    required = {"date", "server", "cpu", "ram", "storage"}
    if not required.issubset(set(lc)):
        raise ValueError("CSV headers must include: date, server, cpu, ram, storage")
    mapping = {orig: orig.lower() for orig in df.columns}
    df = df.rename(columns=mapping)
    df["date"] = pd.to_datetime(df["date"], errors="coerce")
    df = df.dropna(subset=["date"])
    df["server"] = df["server"].astype(str)
    for c in ["cpu", "ram", "storage"]:
        df[c] = pd.to_numeric(df[c], errors="coerce").fillna(0)
    df = df[["date", "server", "cpu", "ram", "storage"]].rename(columns={"ram": "ram_gb", "storage": "storage_gb"})
    return df

def detect_and_convert_ram_sum_to_gb(raw_sum, raw_max, baseline_gb):
    try:
        rs = float(raw_sum); rm = float(raw_max)
    except Exception:
        return 0.0
    if baseline_gb <= 0:
        return rs / 1024.0 if abs(rm) > 5000 else rs
    if abs(rm) > abs(baseline_gb) * 10 or abs(rm) > 5000:
        return rs / 1024.0
    return rs

# ---------------- Capacity Logic ----------------
def calculate_capacity():
    try:
        inv_sql = """
            SELECT
                COALESCE(SUM(NULLIF(TRIM(servercores), '')::numeric),0) AS cpu,
                COALESCE(SUM(NULLIF(TRIM(servermemory), '')::numeric)/1024.0,0) AS ram_gb,
                COALESCE(SUM(NULLIF(TRIM(totaldisk), '')::numeric),0) AS storage_gb
            FROM inventory
            WHERE assetstatus IN (:s1, :s2) AND assetlocation = :loc AND assettype = :atype
        """
        inv = pd.read_sql(text(inv_sql), ENGINE, params={"s1": INVENTORY_STATUS[0], "s2": INVENTORY_STATUS[1], "loc": INVENTORY_LOCATION, "atype": INVENTORY_TYPE})
        base_cpu = float(inv["cpu"].iloc[0])
        base_ram = float(inv["ram_gb"].iloc[0])
        base_stg = float(inv["storage_gb"].iloc[0])
    except Exception:
        base_cpu = base_ram = base_stg = 0.0

    try:
        ev_sql = """
            SELECT
                COALESCE(SUM(cpu_delta) FILTER (WHERE reconciled = false), 0) AS cpu_sum,
                COALESCE(SUM(ram_delta_gb) FILTER (WHERE reconciled = false), 0) AS ram_sum_raw,
                COALESCE(MAX(ABS(ram_delta_gb)) FILTER (WHERE reconciled = false), 0) AS ram_max_raw,
                COALESCE(SUM(storage_delta_gb) FILTER (WHERE reconciled = false), 0) AS storage_sum
            FROM capacity_events
        """
        ev = pd.read_sql(text(ev_sql), ENGINE)
        cpu_sum = float(ev["cpu_sum"].iloc[0])
        ram_sum_raw = float(ev["ram_sum_raw"].iloc[0])
        ram_max_raw = float(ev["ram_max_raw"].iloc[0])
        stg_sum = float(ev["storage_sum"].iloc[0])
    except Exception:
        cpu_sum = ram_sum_raw = ram_max_raw = stg_sum = 0.0

    ram_sum_gb = detect_and_convert_ram_sum_to_gb(ram_sum_raw, ram_max_raw, base_ram)
    used_cpu = base_cpu + cpu_sum
    used_ram = base_ram + ram_sum_gb
    used_stg = base_stg + stg_sum
    total_stg_gb = TOTAL_CAPACITY.get("STORAGE", 0) * 1024.0

    def mk_kpi(used, total):
        reserved = total * RESERVED_PERCENT
        usable = max(total - reserved, 0)
        used_val = max(used, 0)
        pct = (used_val / usable * 100) if usable > 0 else 0
        available = max(usable - used_val, 0)
        return {"used": used_val, "total": total, "reserved": reserved, "usable": usable, "available": available, "pct": pct}

    return {
        "CPU": mk_kpi(used_cpu, TOTAL_CAPACITY.get("CPU", 0)),
        "RAM": mk_kpi(used_ram, TOTAL_CAPACITY.get("RAM", 0)),
        "STORAGE": mk_kpi(used_stg, total_stg_gb)
    }

def build_trend(resource):
    # Same trend logic as before
    try:
        inv_sql = """
            SELECT
                COALESCE(SUM(NULLIF(TRIM(servercores), '')::numeric),0) AS cpu,
                COALESCE(SUM(NULLIF(TRIM(servermemory), '')::numeric)/1024.0,0) AS ram_gb,
                COALESCE(SUM(NULLIF(TRIM(totaldisk), '')::numeric),0) AS storage_gb
            FROM inventory
            WHERE assetstatus IN (:s1, :s2) AND assetlocation = :loc AND assettype = :atype
        """
        inv = pd.read_sql(text(inv_sql), ENGINE, params={"s1": INVENTORY_STATUS[0], "s2": INVENTORY_STATUS[1], "loc": INVENTORY_LOCATION, "atype": INVENTORY_TYPE})
        col_name = "cpu" if resource == "CPU" else ("ram_gb" if resource == "RAM" else "storage_gb")
        baseline = float(inv[col_name].iloc[0])
    except Exception:
        baseline = 0.0

    today = datetime.today().date()
    start = today - timedelta(days=30)

    try:
        sql = """
            SELECT DATE(event_time) AS d,
                   SUM(CASE WHEN :r='CPU' THEN COALESCE(cpu_delta,0)
                            WHEN :r='RAM' THEN COALESCE(ram_delta_gb,0)
                            WHEN :r='STORAGE' THEN COALESCE(storage_delta_gb,0) END) AS v
            FROM capacity_events
            WHERE event_time >= :start_date AND reconciled = false
            GROUP BY DATE(event_time) ORDER BY d
        """
        df = pd.read_sql(text(sql), ENGINE, params={"r": resource, "start_date": start})
    except Exception:
        df = pd.DataFrame()

    date_range = pd.date_range(start, today)
    if df.empty:
        df = pd.DataFrame({"d": date_range, "v": 0.0})
    else:
        df["d"] = pd.to_datetime(df["d"])
        df = df.set_index("d").reindex(date_range).fillna(0).reset_index().rename(columns={"index": "d"})

    if resource == "RAM":
        max_v = df["v"].abs().max()
        if max_v > (abs(baseline)*10 if baseline>0 else 5000):
            df["v"] = df["v"] / 1024.0

    df["used"] = baseline + df["v"].cumsum()

    if resource == "STORAGE":
        df["plot"] = df["used"] / 1024.0 
        y_label = "Used (TB)"
        line_color = COLORS["storage"]
    elif resource == "RAM":
        df["plot"] = df["used"]
        y_label = "Used (GB)"
        line_color = COLORS["ram"]
    else:
        df["plot"] = df["used"]
        y_label = "Used (Cores)"
        line_color = COLORS["cpu"]

    fig = go.Figure()
    fig.add_trace(go.Scatter(x=df["d"], y=df["plot"], mode="lines", line=dict(color=line_color, width=3, shape='spline'), fill="tozeroy", fillcolor=f"rgba{tuple(int(line_color.lstrip('#')[i:i+2], 16) for i in (0, 2, 4)) + (0.1,)}", hovertemplate='%{y:.2f}<extra></extra>'))
    base_plot_val = baseline / 1024.0 if resource == "STORAGE" else baseline
    fig.add_trace(go.Scatter(x=[df["d"].iloc[0], df["d"].iloc[-1]], y=[base_plot_val, base_plot_val], mode="lines", line=dict(color="gray", width=1, dash="dot"), hoverinfo="skip"))
    fig.update_layout(template="plotly_white", margin=dict(l=40, r=20, t=30, b=30), height=300, hovermode="x unified", paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)', xaxis=dict(showgrid=False, showline=True, linecolor="#eee"), yaxis=dict(showgrid=True, gridcolor="#eee", title=y_label), showlegend=False)
    return fig

# ---------------- Reconciler ----------------
_reconcile_lock = threading.Lock()
def auto_reconcile_pending_events(thresholds=None):
    if thresholds is None:
        thresholds = {"cpu_abs":1, "ram_mb_abs":512, "storage_gb_abs":5, "pct_tolerance":0.20}
    matched = []
    try:
        if not _reconcile_lock.acquire(blocking=False): return {"status":"skipped"}
        pending_df = pd.read_sql(text("SELECT id, assetuniquename, cpu_delta, ram_delta_gb, storage_delta_gb FROM capacity_events WHERE pending_inventory = true AND reconciled = false"), ENGINE)
        for _, row in pending_df.iterrows():
            sid = int(row["id"]); server = row["assetuniquename"]
            inv = pd.read_sql(text("SELECT servercores, servermemory, totaldisk FROM inventory WHERE assetuniquename = :s LIMIT 1"), ENGINE, params={"s": server})
            if inv.empty: continue
            try: i_cpu = float(inv["servercores"].iloc[0] or 0)
            except: i_cpu = 0.0
            try: i_ram = float(inv["servermemory"].iloc[0] or 0)
            except: i_ram = 0.0
            try: i_stg = float(inv["totaldisk"].iloc[0] or 0)
            except: i_stg = 0.0
            e_cpu = float(row["cpu_delta"] or 0)
            e_ram_raw = float(row["ram_delta_gb"] or 0)
            e_stg = float(row["storage_delta_gb"] or 0)
            e_ram_mb = e_ram_raw if abs(e_ram_raw) > 1024 else e_ram_raw * 1024.0
            c_ok = (abs(e_cpu - i_cpu) <= thresholds["cpu_abs"]) or (abs(e_cpu - i_cpu) <= thresholds["pct_tolerance"] * max(1, i_cpu))
            r_ok = (abs(e_ram_mb - i_ram) <= thresholds["ram_mb_abs"]) or (abs(e_ram_mb - i_ram) <= thresholds["pct_tolerance"] * max(1, i_ram))
            s_ok = (abs(e_stg - i_stg) <= thresholds["storage_gb_abs"]) or (abs(e_stg - i_stg) <= thresholds["pct_tolerance"] * max(1, i_stg))
            if c_ok and r_ok and s_ok:
                with ENGINE.begin() as conn:
                    conn.execute(text("UPDATE capacity_events SET reconciled=true, pending_inventory=false, reconciled_at=now() WHERE id=:id"), {"id": sid})
                matched.append(sid)
        return {"matched": len(matched)}
    except Exception as e:
        logger.error(f"Reconcile error: {e}")
        return {"error": str(e)}
    finally:
        if _reconcile_lock.locked(): _reconcile_lock.release()

def reconcile_loop():
    time.sleep(5)
    while True:
        auto_reconcile_pending_events()
        time.sleep(RECONCILE_INTERVAL)

if RUN_RECONCILER:
    threading.Thread(target=reconcile_loop, daemon=True).start()

def insert_event(server, cpu, ram_mb, storage_gb, source, date=None, pending=True):
    date = date or now_utc()
    try:
        with ENGINE.begin() as conn:
            conn.execute(text("INSERT INTO capacity_events (assetuniquename, cpu_delta, ram_delta_gb, storage_delta_gb, source, event_time, pending_inventory, reconciled) VALUES (:s, :c, :r, :st, :src, :et, :p, false)"), {"s": server, "c": cpu, "r": ram_mb, "st": storage_gb, "src": source, "et": date, "p": pending})
        return True, "OK"
    except Exception as e:
        return False, str(e)

# ---------------- UI Components ----------------
app = Dash(__name__, external_stylesheets=[dbc.themes.ZEPHYR, "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"], suppress_callback_exceptions=True)
app.title = "Capacity Manager"

app.index_string = '''
<!DOCTYPE html>
<html>
    <head>
        {%metas%}
        <title>{%title%}</title>
        {%favicon%}
        {%css%}
        <style>
            body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 16rem; padding: 2rem 1rem; background-color: #ffffff; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 1000; }
            .content { margin-left: 17rem; padding: 2rem; transition: margin-left .3s; }
            .custom-card { border: none; border-radius: 12px; background: #ffffff; box-shadow: 0 4px 6px rgba(0,0,0,0.04); transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
            .custom-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.08); }
            .kpi-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #6c757d; font-weight: 600; }
            .kpi-value { font-size: 2rem; font-weight: 700; color: #2c3e50; }
            .kpi-sub { font-size: 0.8rem; color: #adb5bd; }
            .table-modern thead th { border-top: none; border-bottom: 2px solid #e9ecef; font-weight: 600; color: #495057; }
            .table-modern tbody td { vertical-align: middle; border-color: #f1f3f5; }
            
            /* Custom Spacing for Inventory Table */
            .table-spaced th, .table-spaced td { padding: 15px 20px !important; }
            
            .nav-pills .nav-link { color: #555; font-weight: 500; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; cursor: pointer; }
            .nav-pills .nav-link:hover { background-color: #f1f3f5; color: #000; }
            .nav-pills .nav-link.active { background-color: #e7f1ff; color: #0d6efd; font-weight: 700; }
        </style>
    </head>
    <body>
        {%app_entry%}
        <footer>{%config%}{%scripts%}{%renderer%}</footer>
    </body>
</html>
'''

# --- Layout ---
sidebar = html.Div([
    html.H3(["Capacity", html.Span(".", style={"color": "#0d6efd"})], className="display-6 fw-bold mb-4 px-2"),
    html.Hr(),
    # Nav items are now n_clicks inputs
    dbc.Nav([
        dbc.NavLink([html.I(className="bi bi-speedometer2 me-2"), "Dashboard"], id="btn-dashboard", active=True),
        dbc.NavLink([html.I(className="bi bi-list-check me-2"), "Events"], id="btn-events"),
        dbc.NavLink([html.I(className="bi bi-server me-2"), "Inventory"], id="btn-inventory"),
        dbc.NavLink([html.I(className="bi bi-gear me-2"), "Settings"], id="btn-settings", disabled=True),
    ], vertical=True, pills=True, className="mb-4"),
    html.Div([html.Small("Last Sync:", className="text-muted d-block"), html.Small(id="last-sync", className="fw-bold text-primary")], className="mt-auto pt-4 border-top")
], className="sidebar")

def kpi_card(title, value, sub_text, pct, color, icon_class):
    return dbc.Card([
        dbc.CardBody([
            dbc.Row([
                dbc.Col([html.Div(title, className="kpi-title mb-1"), html.Div(value, className="kpi-value"), html.Div(sub_text, className="kpi-sub mt-1")]),
                dbc.Col([html.Div(html.I(className=f"{icon_class} fs-2 text-{color}"), className="text-end opacity-50")], width="auto")
            ]),
            dbc.Progress(value=min(pct, 100), color=color, className="mt-3", style={"height": "6px"}),
            html.Div(f"{pct:.1f}% Utilized", className=f"text-end mt-1 text-{color} fw-bold", style={"fontSize": "0.75rem"})
        ])
    ], className="custom-card h-100")

# Views are pre-defined but hidden via CSS style. This ensures callbacks always find IDs.
view_dashboard = html.Div(id="view-dashboard", children=[
    dcc.Loading(type="dot", children=dbc.Row(id="kpi-row", className="g-4 mb-5")),
    html.Div(id="alerts-container"),
    dbc.Row([
        dbc.Col(dbc.Card([dbc.CardHeader("CPU Trend (30 Days)", className="bg-white border-0 fw-bold"), dbc.CardBody(dcc.Graph(id="cpu-trend", config={'displayModeBar': False}))], className="custom-card h-100"), lg=4),
        dbc.Col(dbc.Card([dbc.CardHeader("RAM Trend (30 Days)", className="bg-white border-0 fw-bold"), dbc.CardBody(dcc.Graph(id="ram-trend", config={'displayModeBar': False}))], className="custom-card h-100"), lg=4),
        dbc.Col(dbc.Card([dbc.CardHeader("Storage Trend (30 Days)", className="bg-white border-0 fw-bold"), dbc.CardBody(dcc.Graph(id="storage-trend", config={'displayModeBar': False}))], className="custom-card h-100"), lg=4),
    ], className="mb-5 g-4")
])

view_events = html.Div(id="view-events", style={"display": "none"}, children=[
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardHeader([html.I(className="bi bi-plus-circle me-2"), "New Capacity Event"], className="bg-white border-0 fw-bold text-primary"),
                dbc.CardBody([
                    dbc.Tabs([
                        dbc.Tab(label="Manual Entry", tab_id="tab-manual", children=[
                            html.Div([
                                dbc.Label("Server Name", className="mt-3 fw-bold"),
                                dbc.Input(id="server", placeholder="e.g. app-prod-01", className="mb-2"),
                                dbc.Row([dbc.Col([dbc.Label("CPU Δ"), dbc.Input(id="cpu", type="number", placeholder="Cores")]), dbc.Col([dbc.Label("RAM Δ (GB)"), dbc.Input(id="ram", type="number", placeholder="GB")]), dbc.Col([dbc.Label("Storage Δ (GB)"), dbc.Input(id="storage", type="number", placeholder="GB")])], className="mb-3"),
                                dbc.Button("Submit Event", id="submit", color="primary", className="w-100 shadow-sm"),
                                html.Div(id="manual-msg", className="mt-3")
                            ])
                        ]),
                        dbc.Tab(label="Bulk CSV Upload", tab_id="tab-upload", children=[
                            html.Div([
                                html.P("Format: date,server,cpu,ram,storage", className="text-muted mt-3 small"),
                                dcc.Upload(id="csv-upload", children=dbc.Button([html.I(className="bi bi-cloud-upload me-2"), "Select CSV File"], color="secondary", outline=True, className="w-100 dashed-border"), multiple=False),
                                html.Div(id="csv-msg", className="mt-3")
                            ])
                        ])
                    ], active_tab="tab-manual")
                ])
            ], className="custom-card h-100")
        ], lg=5),
        dbc.Col([
            dbc.Card([
                dbc.CardHeader([html.Div([html.I(className="bi bi-list-check me-2"), "Recent Events"], className="d-inline-block fw-bold"), html.Div(dcc.Dropdown(id="recent-days", options=[7, 30, 90], value=30, clearable=False, style={"width": "100px"}), className="float-end")], className="bg-white border-0"),
                dbc.CardBody(html.Div(id="recent-table", style={"maxHeight": "300px", "overflowY": "auto"}))
            ], className="custom-card h-100")
        ], lg=7)
    ], className="mb-5 g-4")
])

view_inventory = html.Div(id="view-inventory", style={"display": "none"}, children=[
    dbc.Card([
        dbc.CardHeader([html.I(className="bi bi-server me-2"), "Filtered Inventory"], className="bg-white border-0 fw-bold"),
        dbc.CardBody(html.Div(id="inventory-table"))
    ], className="custom-card mb-5")
])

content = html.Div([
    dbc.Row([
        dbc.Col(html.H4("Capacity Management", className="fw-bold text-secondary"), width=8),
        dbc.Col(dbc.Button([html.I(className="bi bi-arrow-clockwise me-2"), "Refresh Data"], id="refresh", color="light", size="sm", className="shadow-sm"), className="text-end", width=4)
    ], className="mb-4 align-items-center"),
    # Auto-Refresh set to 60 seconds (60000ms)
    dcc.Interval(id="interval", interval=60*1000, n_intervals=0),
    view_dashboard,
    view_events,
    view_inventory
], className="content")

app.layout = html.Div([sidebar, content])

# ---------------- Callbacks ----------------

# Callback 1: Handle Tab Switching (Visibility)
@app.callback(
    [Output("view-dashboard", "style"), Output("view-events", "style"), Output("view-inventory", "style"),
     Output("btn-dashboard", "active"), Output("btn-events", "active"), Output("btn-inventory", "active")],
    [Input("btn-dashboard", "n_clicks"), Input("btn-events", "n_clicks"), Input("btn-inventory", "n_clicks")]
)
def switch_tab(b1, b2, b3):
    ctx = callback_context
    bid = ctx.triggered[0]["prop_id"].split(".")[0] if ctx.triggered else "btn-dashboard"
    
    show = {"display": "block"}
    hide = {"display": "none"}
    
    if bid == "btn-events":
        return hide, show, hide, False, True, False
    elif bid == "btn-inventory":
        return hide, hide, show, False, False, True
    return show, hide, hide, True, False, False

# Callback 2: Data & Logic
@app.callback(
    [Output("kpi-row", "children"), Output("alerts-container", "children"),
     Output("cpu-trend", "figure"), Output("ram-trend", "figure"), Output("storage-trend", "figure"),
     Output("recent-table", "children"), Output("inventory-table", "children"),
     Output("manual-msg", "children"), Output("csv-msg", "children"), Output("last-sync", "children")],
    [Input("interval", "n_intervals"), Input("refresh", "n_clicks"), Input("submit", "n_clicks"), Input("csv-upload", "contents"), Input("recent-days", "value")],
    [State("server", "value"), State("cpu", "value"), State("ram", "value"), State("storage", "value"), State("csv-upload", "filename")]
)
def update_all(n_int, n_ref, n_sub, csv_con, days, srv, cpu, ram, stg, csv_name):
    ctx = callback_context
    trigger = ctx.triggered[0]["prop_id"].split(".")[0] if ctx.triggered else ""
    man_res = no_update
    csv_res = no_update
    force = False

    if trigger == "submit" and n_sub:
        if not srv: man_res = dbc.Alert("Server name required", color="danger")
        else:
            try:
                r = ENGINE.execute(text("SELECT 1 FROM inventory WHERE assetuniquename=:s"), {"s":srv}).fetchone()
                ok, msg = insert_event(srv, float(cpu or 0), float(ram or 0)*1024, float(stg or 0), "MANUAL", pending=(r is None))
                man_res = dbc.Toast("Saved", header="Success", icon="success", duration=3000, is_open=True, style={"position":"fixed", "top":10, "right":10}) if ok else dbc.Alert(msg, color="danger")
                force = True
            except Exception as e: man_res = dbc.Alert(str(e), color="danger")

    if trigger == "csv-upload" and csv_con:
        try:
            df = parse_csv(csv_con, csv_name)
            cnt = 0
            for _, r in df.iterrows():
                ex = ENGINE.execute(text("SELECT 1 FROM inventory WHERE assetuniquename=:s"), {"s":r["server"]}).fetchone()
                ok, _ = insert_event(r["server"], r["cpu"], r["ram_gb"]*1024, r["storage_gb"], "CSV", r["date"], pending=(ex is None))
                if ok: cnt += 1
            csv_res = dbc.Toast(f"Imported {cnt}", header="Success", icon="success", duration=3000, is_open=True, style={"position":"fixed", "top":10, "right":10})
            force = True
        except Exception as e: csv_res = dbc.Alert(str(e), color="danger")

    if force or trigger in ("interval", "refresh", "recent-days", ""):
        cap = calculate_capacity()
        kpi_cols = []
        alerts = []
        for k, icon, col in [("CPU","bi-cpu","primary"), ("RAM","bi-memory","success"), ("STORAGE","bi-hdd-network","info")]:
            d = cap[k]
            # Storage fix: If STORAGE, input is GB, convert to TB for display
            if k == "STORAGE":
                u_txt = fmt_storage_tb(d["used"]); a_txt = fmt_storage_tb(d["available"])
            elif k == "RAM":
                u_txt = fmt_ram_gb(d["used"]); a_txt = fmt_ram_gb(d["available"])
            else:
                u_txt = fmt_cpu(d["used"]); a_txt = fmt_cpu(d["available"])
            
            c_curr = col if d["pct"] < 80 else ("warning" if d["pct"] < 90 else "danger")
            kpi_cols.append(dbc.Col(kpi_card(k, u_txt, f"Avail: {a_txt}", d["pct"], c_curr, icon), md=4))
            if d["pct"] > 90: alerts.append(dbc.Alert(f"High {k} Usage!", color="danger"))

        cpu_fig = build_trend("CPU"); ram_fig = build_trend("RAM"); stg_fig = build_trend("STORAGE")
        
        d_val = int(days or 30)
        rec_df = pd.read_sql(text("SELECT event_time, assetuniquename, cpu_delta, ram_delta_gb, storage_delta_gb FROM capacity_events WHERE event_time >= :d ORDER BY event_time DESC LIMIT 100"), ENGINE, params={"d": datetime.now()-timedelta(days=d_val)})
        if not rec_df.empty:
            rec_df.columns = ["Date", "Server", "CPU", "RAM (GB)", "Stg (GB)"]
            rec_tbl = dbc.Table.from_dataframe(rec_df, striped=True, hover=True, size="sm", className="table-modern")
        else: rec_tbl = html.P("No recent events", className="text-muted")

        inv_df = pd.read_sql(text("SELECT assetuniquename AS \"Server\", assetipaddress AS \"IP\", servercores AS \"CPU\", ROUND(COALESCE(NULLIF(TRIM(servermemory),''),'0')::numeric/1024.0, 2) AS \"RAM (GB)\", totaldisk AS \"Storage (GB)\" FROM inventory WHERE assetstatus IN (:s1, :s2) AND assetlocation=:loc AND assettype=:at ORDER BY assetuniquename"), ENGINE, params={"s1":INVENTORY_STATUS[0], "s2":INVENTORY_STATUS[1], "loc":INVENTORY_LOCATION, "at":INVENTORY_TYPE})
        # Add 'table-spaced' class here for the user requested spacing
        inv_tbl = dbc.Table.from_dataframe(inv_df, striped=True, bordered=False, hover=True, className="table-modern table-spaced") if not inv_df.empty else html.P("No Data")

        return kpi_cols, alerts, cpu_fig, ram_fig, stg_fig, rec_tbl, inv_tbl, man_res, csv_res, datetime.now().strftime("%H:%M:%S")

    return no_update, no_update, no_update, no_update, no_update, no_update, no_update, man_res, csv_res, no_update

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8050, debug=False)
