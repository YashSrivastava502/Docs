#!/usr/bin/env python3
"""
Recalculates server_capacity_snapshot from master + all historical events
Run after ingestion or on fixed schedule
"""

import logging
from datetime import datetime
import pandas as pd
from database import query_df, run_sql

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[logging.FileHandler("logs/snapshot_refresh.log"), logging.StreamHandler()]
)
logger = logging.getLogger(__name__)

def refresh_snapshot():
    logger.info("Refreshing snapshot")

    try:
        # Get latest baseline
        master = query_df("""
            SELECT total_storage_gb, total_ram_gb, total_cpu_cores
            FROM server_capacity_master
            ORDER BY last_updated DESC LIMIT 1
        """).iloc[0]

        # Sum all historical deltas
        deltas = query_df("""
            SELECT 
                resource_type,
                SUM(change_value) AS total_delta
            FROM server_capacity_events
            GROUP BY resource_type
        """).set_index("resource_type")["total_delta"].to_dict()

        used = {
            "storage": master["total_storage_gb"] + deltas.get("storage", 0),
            "ram":     master["total_ram_gb"]     + deltas.get("ram", 0),
            "cpu":     master["total_cpu_cores"]  + deltas.get("cpu", 0),
        }

        # Safety: cannot be negative
        used = {k: max(0, v) for k, v in used.items()}

        # Insert new snapshot
        run_sql("""
            INSERT INTO server_capacity_snapshot
            (storage_used_gb, ram_used_gb, cpu_used_cores, snapshot_time)
            VALUES (:s, :r, :c, NOW())
        """, {
            "s": used["storage"],
            "r": used["ram"],
            "c": used["cpu"]
        })

        logger.info(f"New snapshot created â†’ Storage: {used['storage']:.1f} GB | RAM: {used['ram']:.1f} GB | CPU: {used['cpu']:.0f} cores")

    except Exception as e:
        logger.error("Snapshot refresh failed", exc_info=True)


if __name__ == "__main__":
    refresh_snapshot()
