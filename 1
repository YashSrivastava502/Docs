---
- name: Configure FortiGate firewall
  hosts: fortigate
  gather_facts: no
  vars_files:
    - fw_config_li.yml

  tasks:

    - name: Remove old SSH host key
      command: "ssh-keygen -R {{ ansible_host }}"
      delegate_to: localhost
      run_once: true
      ignore_errors: yes

    - name: Ping FortiGate device
      command: ping -c 2 {{ fortigate_ip }}
      register: ping_result
      ignore_errors: yes
      changed_when: false

    - name: Show result if FortiGate is up
      debug:
        msg: "FortiGate is reachable"
      when: ping_result.rc == 0

    - name: Show result if FortiGate is down
      debug:
        msg: "FortiGate is unreachable"
      when: ping_result.rc != 0

    - name: Create Address Objects on FortiGate
      expect:
        command: ssh {{ uname }}@{{ fortigate_ip }}
        responses:
          "(?i)password:": "{{ password1 }}"
          "(?i)continue connecting (yes/no)?": "yes"
          "Are you sure you want to continue connecting (yes/no/[fingerprint])?": "yes\n"
          "#": |
            config vdom
            edit root
            config firewall address
            {% for item in address_objects %}
            edit {{ item.name }}
            set type {{ item.type }}
            {% if item.type == 'subnet' %}
            set subnet {{ item.subnet }}
            {% elif item.type == 'fqdn' %}
            set fqdn {{ item.fqdn }}
            {% endif %}
            set comment {{ comment_string }}
            next
            {% endfor %}
            end
            exit
      when: ping_result.rc == 0
      delegate_to: localhost
      no_log: true

    - name: Create Address Group with all members
      expect:
        command: ssh {{ uname }}@{{ fortigate_ip }}
        responses:
          "(?i)password:": "{{ password1 }}"
          "(?i)continue connecting (yes/no)?": "yes"
          "Are you sure you want to continue connecting (yes/no/[fingerprint])?": "yes\n"
          "#": |
            config vdom
            edit root
            config firewall addrgrp
            edit {{ address_group_name }}
            {% for item in address_objects %}
            append member {{ item.name }}
            {% endfor %}
            set comment {{ comment_string }}
            next
            end
            exit
      when: ping_result.rc == 0
      delegate_to: localhost
      no_log: true
