# ===============================
# DNS Fallback / Restore Script
# ===============================

$dc1 = "usel-pr-dc1"  # Primary DC name
$dnsServer = $env:COMPUTERNAME
$backupPath = "C:\Scripts\original-records.csv"

# Check if DC1 is reachable
if (Test-Connection -ComputerName $dc1 -Count 2 -Quiet) {
    Write-Host "DC1 is reachable. Running Fallback Mode..." -ForegroundColor Cyan

    # Step 1: Delete all CNAMEs from all zones
    Write-Host "`n--- Step 1: Removing all CNAME records ---"
    $zones = Get-DnsServerZone
    foreach ($zone in $zones) {
        $cnameRecords = Get-DnsServerResourceRecord -ZoneName $zone.ZoneName -RRType CNAME -ErrorAction SilentlyContinue
        foreach ($cname in $cnameRecords) {
            Remove-DnsServerResourceRecord -ZoneName $zone.ZoneName -Name $cname.HostName -RRType CNAME -Force -ErrorAction SilentlyContinue
            Write-Host "Deleted CNAME: $($cname.HostName) in zone $($zone.ZoneName)"
        }
    }

    # Step 2: Delete DR A records (ending in -dr)
    Write-Host "`n--- Step 2: Removing DR A records (with -dr suffix) ---"
    foreach ($zone in $zones) {
        $aRecords = Get-DnsServerResourceRecord -ZoneName $zone.ZoneName -RRType A -ErrorAction SilentlyContinue
        foreach ($a in $aRecords) {
            if ($a.HostName -like "*-dr") {
                Remove-DnsServerResourceRecord -ZoneName $zone.ZoneName -Name $a.HostName -RRType A -Force -ErrorAction SilentlyContinue
                Write-Host "Deleted DR A Record: $($a.HostName) in zone $($zone.ZoneName)"
            }
        }
    }

    # Step 3: Restore original A records from backup CSV
    Write-Host "`n--- Step 3: Restoring original A records from backup CSV ---"

    if (Test-Path $backupPath) {
        $records = Import-Csv $backupPath

        foreach ($rec in $records) {
            $zoneName = $rec.Zone
            $name = $rec.Name
            $type = $rec.Type
            $data = $rec.Data

            try {
                # Only restore A records with valid IPs
                if ($type -eq "A" -and $data -match "^\d{1,3}(\.\d{1,3}){3}$") {
                    $existing = Get-DnsServerResourceRecord -ZoneName $zoneName -Name $name -ErrorAction SilentlyContinue

                    if (-not $existing) {
                        Add-DnsServerResourceRecordA -ZoneName $zoneName -Name $name -IPv4Address $data -TimeToLive 01:00:00 -ErrorAction Stop
                        Write-Host "Restored A record: $name → $data in $zoneName"
                    } else {
                        Write-Host "Skipped (already exists): $name in $zoneName"
                    }
                } else {
                    Write-Warning "Skipping invalid or empty IP for $name in $zoneName"
                }
            } catch {
                Write-Warning "Error restoring $name in $zoneName: $($_.Exception.Message)"
            }
        }
    } else {
        Write-Warning "Backup file not found: $backupPath"
    }

    Write-Host "`n✔ Fallback complete: Original A records restored, DR records and CNAMEs removed." -ForegroundColor Green
}
else {
    Write-Host "❌ DC1 is still unreachable. Skipping fallback mode." -ForegroundColor Red
}
