#!/bin/bash

# Configuration
RG="usei-dr-rgp01"
LOCATION="East US"

VM1_NAME="use1-dr-websrv01-vm"
VM2_NAME="use1-dr-websrv02-vm"

VNET1="usel-drd-fp-inf-net01"
SUBNET1="usel-dr01-fp-srv-snet01"

VNET2="use1-drd-fp-hub-net01"
SUBNET2="usel-drd-fp-hub-srv-snet01"

VM_SIZE="Standard_B1s"
USERNAME="azureuser"
PASSWORD="YourStrongPassword123!"

SNAPSHOT_NAME="use1-dr-websrv01-snapshot"
DISK_NAME="use1-dr-websrv01-clone-disk"

STORAGE_ACCOUNT="fpinfbackup"
CONTAINER="syseng"
BLOB_PATH="use1-dr-websrv01-vm/use1-dr-websrv01-osdisk.vhd"

# SAS token without '?'
SAS_TOKEN="sp=racwl&st=2025-08-08T06:34:10Z&se=2025-08-11T14:49:10Z&spr=https&sv=2024-11-04&sr=c&sig=aYFoA023qqy6nVe%2B1DuzTNpaQBZy1PuCUSV08KLCZVw%3D"

echo "Creating VM1..."
az vm create \
  --resource-group "$RG" \
  --name "$VM1_NAME" \
  --image Ubuntu2204 \
  --size "$VM_SIZE" \
  --admin-username "$USERNAME" \
  --admin-password "$PASSWORD" \
  --vnet-name "$VNET1" \
  --subnet "$SUBNET1" \
  --public-ip-address "" \
  --location "$LOCATION" \
  --nsg "${VM1_NAME}-nsg" \
  --output none
sleep 30

echo "Installing NGINX with blue page on VM1..."
az vm extension set \
  --resource-group "$RG" \
  --vm-name "$VM1_NAME" \
  --name CustomScript \
  --publisher Microsoft.Azure.Extensions \
  --settings '{"commandToExecute":"sudo apt update && sudo apt install -y nginx && echo \"<html><body style='\''background-color:blue;'\''><h1>Blue Page</h1></body></html>\" | sudo tee /var/www/html/index.html && sudo systemctl restart nginx"}' \
  --output none
sleep 20

echo "Deallocating VM1..."
az vm deallocate --resource-group "$RG" --name "$VM1_NAME" --output none
sleep 60

OSDISK_NAME=$(az vm show --resource-group "$RG" --name "$VM1_NAME" --query "storageProfile.osDisk.name" -o tsv)

echo "Creating snapshot..."
az snapshot create \
  --resource-group "$RG" \
  --source "$OSDISK_NAME" \
  --name "$SNAPSHOT_NAME" \
  --location "$LOCATION" \
  --output none
sleep 40

echo "Generating SAS URL for snapshot..."
SAS_URL=$(az snapshot grant-access \
  --resource-group "$RG" \
  --name "$SNAPSHOT_NAME" \
  --duration-in-seconds 14400 \
  --query accessSas -o tsv)

echo "Copying snapshot to blob..."
az storage blob copy start \
  --account-name "$STORAGE_ACCOUNT" \
  --sas-token "$SAS_TOKEN" \
  --destination-container "$CONTAINER" \
  --destination-blob "$BLOB_PATH" \
  --source-uri "$SAS_URL" \
  --output none

while true; do
  STATUS=$(az storage blob show \
    --account-name "$STORAGE_ACCOUNT" \
    --sas-token "$SAS_TOKEN" \
    --container-name "$CONTAINER" \
    --name "$BLOB_PATH" \
    --query "properties.copy.status" -o tsv)
  echo "Copy status: $STATUS"
  [[ "$STATUS" == "success" ]] && break
  sleep 60
done
sleep 30

BLOB_URL="https://${STORAGE_ACCOUNT}.blob.core.windows.net/${CONTAINER}/${BLOB_PATH}?${SAS_TOKEN}"
echo "Creating managed disk from blob..."
az disk create \
  --resource-group "$RG" \
  --name "$DISK_NAME" \
  --source "$BLOB_URL" \
  --os-type Linux \
  --location "$LOCATION" \
  --output none
sleep 40

echo "Creating VM2 from cloned disk..."
az vm create \
  --resource-group "$RG" \
  --name "$VM2_NAME" \
  --attach-os-disk "$DISK_NAME" \
  --os-type Linux \
  --size "$VM_SIZE" \
  --vnet-name "$VNET2" \
  --subnet "$SUBNET2" \
  --admin-username "$USERNAME" \
  --admin-password "$PASSWORD" \
  --public-ip-address "" \
  --location "$LOCATION" \
  --nsg "${VM2_NAME}-nsg" \
  --output none
sleep 30

echo "VM creation and cloning process completed."
