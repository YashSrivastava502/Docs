$dc1 = "usel-pr-dc1"  # Change as needed
$dnsServer = $env:COMPUTERNAME
$backupPath = "C:\Scripts\original-records.csv"

# Check if DC1 is reachable
if (Test-Connection -ComputerName $dc1 -Count 2 -Quiet) {
    Write-Host "DC1 is reachable. Running Fallback Mode..."

    # Step 1: Delete all CNAMEs from all zones
    $zones = Get-DnsServerZone
    foreach ($zone in $zones) {
        $cnameRecords = Get-DnsServerResourceRecord -ZoneName $zone.ZoneName -RRType CName -ErrorAction SilentlyContinue
        foreach ($cname in $cnameRecords) {
            Remove-DnsServerResourceRecord -ZoneName $zone.ZoneName -Name $cname.HostName -RRType CName -Force
            Write-Host "Deleted CNAME: $($cname.HostName) in zone $($zone.ZoneName)"
        }
    }

    # Step 2: Delete DR A records (ending in -dr)
    foreach ($zone in $zones) {
        $aRecords = Get-DnsServerResourceRecord -ZoneName $zone.ZoneName -RRType A -ErrorAction SilentlyContinue
        foreach ($a in $aRecords) {
            if ($a.HostName -like "*-dr") {
                Remove-DnsServerResourceRecord -ZoneName $zone.ZoneName -Name $a.HostName -RRType A -Force
                Write-Host "Deleted DR A Record: $($a.HostName) in zone $($zone.ZoneName)"
            }
        }
    }

    # Step 3: Restore original A records
    $originals = Import-Csv $backupPath
    foreach ($rec in $originals) {
        try {
            $existing = Get-DnsServerResourceRecord -ZoneName $rec.Zone -Name $rec.Name -ErrorAction SilentlyContinue
            if (-not $existing) {
                Add-DnsServerResourceRecordA -Name $rec.Name -ZoneName $rec.Zone -IPv4Address $rec.IP
                Write-Host "Restored A record: $($rec.Name) → $($rec.IP) in $($rec.Zone)"
            }
        } catch {
            Write-Warning "Error restoring $($rec.Name) in $($rec.Zone): $_"
        }
    }

    Write-Host "`n✔ Fallback complete: Original A records restored, DR records and CNAMEs removed."
} else {
    Write-Host "❌ DC1 is still unreachable. Skipping fallback mode."
}
