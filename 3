$dc1 = "usel-pr-dc1"
$dnsServer = $env:COMPUTERNAME
$backupPath = "C:\Scripts\original-records.csv"
$drCsvPath = "C:\Scripts\records.csv"

# 1. Check if DC1 is unreachable
if (-not (Test-Connection -ComputerName $dc1 -Count 2 -Quiet)) {
    Write-Host "`n❗ DC1 is unreachable. Starting DR Failover Script..."

    # 2. Backup all A records from all zones
    $backup = @()
    $zones = Get-DnsServerZone
    foreach ($zone in $zones) {
        $aRecords = Get-DnsServerResourceRecord -ZoneName $zone.ZoneName -RRType A -ErrorAction SilentlyContinue
        foreach ($a in $aRecords) {
            $backup += [PSCustomObject]@{
                Name = $a.HostName
                IP   = $a.RecordData.IPv4Address.ToString()
                Zone = $zone.ZoneName
            }
        }
    }
    $backup | Export-Csv -Path $backupPath -NoTypeInformation -Encoding UTF8
    Write-Host "✔ Backup saved to $backupPath"

    # 3. Clean all existing A and CNAME records
    foreach ($zone in $zones) {
        $records = Get-DnsServerResourceRecord -ZoneName $zone.ZoneName -ErrorAction SilentlyContinue
        foreach ($rec in $records) {
            if ($rec.RecordType -in @("A", "CNAME")) {
                Remove-DnsServerResourceRecord -ZoneName $zone.ZoneName -Name $rec.HostName -RRType $rec.RecordType -Force -ErrorAction SilentlyContinue
                Write-Host "Deleted $($rec.RecordType) record: $($rec.HostName) in $($zone.ZoneName)"
            }
        }
    }

    # 4. Create DR A records
    $drRecords = Import-Csv $drCsvPath
    foreach ($rec in $drRecords) {
        Add-DnsServerResourceRecordA -Name "$($rec.Name)-dr" -ZoneName $rec.Zone -IPv4Address $rec.IP -ErrorAction Stop
        Write-Host "✔ DR A record created: $($rec.Name)-dr → $($rec.IP) in $($rec.Zone)"
    }

    # 5. Create CNAMEs pointing to DR records (after ensuring original A record is deleted)
    foreach ($rec in $drRecords) {
        $existing = Get-DnsServerResourceRecord -ZoneName $rec.Zone -Name $rec.Name -ErrorAction SilentlyContinue
        if ($existing -and $existing.RecordType -eq "A") {
            Remove-DnsServerResourceRecord -ZoneName $rec.Zone -Name $rec.Name -RRType A -Force
            Write-Host "Removed existing A record for $($rec.Name) before creating CNAME"
        }

        Add-DnsServerResourceRecordCName -Name $rec.Name -HostNameAlias "$($rec.Name)-dr.$($rec.Zone)" -ZoneName $rec.Zone -ErrorAction Stop
        Write-Host "✔ CNAME created: $($rec.Name) → $($rec.Name)-dr"
    }

    Write-Host "`n✅ DR Failover complete!"
} else {
    Write-Host "✅ DC1 is reachable. No failover action required."
}

